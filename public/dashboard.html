<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSL Bot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            color: #333;
            font-size: 36px;
            font-weight: bold;
        }
        
        .stat-card .change {
            color: #4caf50;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .conversations-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .conversations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .conversations-header h2 {
            color: #333;
        }
        
        .filters {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .conversations-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .conversations-table th {
            text-align: left;
            padding: 12px;
            color: #666;
            font-weight: 500;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .conversations-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .conversations-table tr:hover {
            background: #f9f9f9;
        }
        
        .conversations-table th:last-child,
        .conversations-table td:last-child {
            text-align: center;
            width: 150px;
        }
        
        .phase-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .phase-inicial { background: #e3f2fd; color: #1976d2; }
        .phase-pago { background: #fff3e0; color: #f57c00; }
        .phase-post-agendamiento { background: #e8f5e9; color: #4caf50; }
        .phase-revision-certificado { background: #f3e5f5; color: #9c27b0; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active { background: #e8f5e9; color: #4caf50; }
        .status-blocked { background: #ffebee; color: #f44336; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #5a67d8;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #666;
            cursor: pointer;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ BSL WhatsApp Bot Dashboard</h1>
            <p>Panel de control y estad√≠sticas en tiempo real</p>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Conversaciones</h3>
                <div class="value" id="totalConversations">-</div>
            </div>
            <div class="stat-card">
                <h3>Activas (24h)</h3>
                <div class="value" id="activeConversations">-</div>
            </div>
            <div class="stat-card">
                <h3>Usuarios Bloqueados</h3>
                <div class="value" id="blockedUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Tasa de Respuesta</h3>
                <div class="value" id="responseRate">-</div>
            </div>
        </div>
        
        <!-- Bot√≥n de correcci√≥n de datos (temporal) -->
        <div class="conversations-section" style="background: #fff3cd; border: 2px solid #ffc107; margin-bottom: 20px;">
            <div style="padding: 15px;">
                <h3 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è Correcci√≥n de Datos</h3>
                <p style="color: #856404; margin: 0 0 15px 0;">
                    Si has subido n√∫meros y no aparecen como bloqueados, ejecuta esta correcci√≥n:
                </p>
                <button 
                    onclick="fixBlockedUsers()" 
                    style="padding: 10px 20px; background: #ffc107; color: #000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                    üîß Corregir Usuarios Bloqueados
                </button>
                <div id="fixResult" style="margin-top: 10px; display: none;"></div>
            </div>
        </div>
        
        <!-- Secci√≥n de b√∫squeda y gesti√≥n de usuarios bloqueados -->
        <div class="conversations-section">
            <div class="conversations-header">
                <h2>üîç Buscar y Gestionar Usuarios Bloqueados</h2>
                <p>Buscar usuarios bloqueados y desbloquearlos manualmente</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div class="row">
                    <div class="col-md-6">
                        <label style="font-weight: bold; margin-bottom: 8px;">Buscar por n√∫mero o nombre:</label>
                        <input 
                            type="text" 
                            id="searchBlockedUser" 
                            placeholder="Ej: 573001234567 o nombre del usuario"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="col-md-3">
                        <label style="visibility: hidden;">Buscar</label>
                        <button 
                            onclick="searchBlockedUsers()" 
                            style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üîç Buscar
                        </button>
                    </div>
                    <div class="col-md-3">
                        <label style="visibility: hidden;">Ver todos</label>
                        <button 
                            onclick="loadAllBlockedUsers()" 
                            style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üìã Ver Todos los Bloqueados
                        </button>
                    </div>
                </div>
                
                <div id="blockedUsersResults" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
                    <!-- Los resultados aparecer√°n aqu√≠ -->
                </div>
            </div>
        </div>
        
        <!-- Secci√≥n de carga masiva de StopBot -->
        <div class="conversations-section">
            <div class="conversations-header">
                <h2>üö´ Carga Masiva StopBot</h2>
                <p>Agregar n√∫meros que deben estar bloqueados del bot</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div class="row">
                    <div class="col-md-8">
                        <label for="bulkNumbers" style="font-weight: bold; margin-bottom: 8px;">N√∫meros (uno por l√≠nea, separados por comas o espacios):</label>
                        <textarea 
                            id="bulkNumbers" 
                            rows="8" 
                            placeholder="573001234567&#10;573009876543&#10;573001111111&#10;o separados por comas: 573001234567, 573009876543"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label for="stopReason" style="font-weight: bold; margin-bottom: 8px;">Raz√≥n del bloqueo:</label>
                        <input 
                            type="text" 
                            id="stopReason" 
                            placeholder="Ej: Lista negra inicial" 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
                        
                        <button 
                            onclick="submitBulkStopBot()" 
                            style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;"
                            onmouseover="this.style.background='#c82333'" 
                            onmouseout="this.style.background='#dc3545'">
                            üö´ Bloquear N√∫meros
                        </button>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 4px; font-size: 12px;">
                            <strong>Formatos soportados:</strong><br>
                            ‚Ä¢ Un n√∫mero por l√≠nea<br>
                            ‚Ä¢ Separados por comas<br>
                            ‚Ä¢ Separados por espacios<br>
                            ‚Ä¢ Con o sin prefijo +57
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="conversations-section">
            <div class="conversations-header">
                <h2>Conversaciones Recientes</h2>
                <div class="filters">
                    <button class="filter-btn active" onclick="filterConversations('all')">Todas</button>
                    <button class="filter-btn" onclick="filterConversations('inicial')">Inicial</button>
                    <button class="filter-btn" onclick="filterConversations('pago')">Pago</button>
                    <button class="filter-btn" onclick="filterConversations('post-agendamiento')">Post-Agendamiento</button>
                    <button class="refresh-btn" onclick="loadData()">üîÑ Actualizar</button>
                </div>
            </div>
            
            <div id="conversationsContent">
                <div class="loading">Cargando conversaciones...</div>
            </div>
            
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
    
    <script>
        const API_TOKEN = 'admin-secret-token';
        let currentPage = 1;
        let currentFilter = 'all';
        
        async function loadDashboard() {
            try {
                const response = await fetch('/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar dashboard');
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalConversations').textContent = 
                        data.dashboard.conversaciones.total || '0';
                    document.getElementById('activeConversations').textContent = 
                        data.dashboard.conversaciones.activas24h || '0';
                    document.getElementById('blockedUsers').textContent = 
                        data.dashboard.conversaciones.bloqueadas || '0';
                    
                    // Calcular tasa de respuesta
                    const total = data.dashboard.conversaciones.total || 0;
                    const active = data.dashboard.conversaciones.activas24h || 0;
                    const rate = total > 0 ? ((active / total) * 100).toFixed(1) : 0;
                    document.getElementById('responseRate').textContent = `${rate}%`;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        async function loadConversations(page = 1, fase = null) {
            try {
                let url = `/api/admin/conversations?page=${page}&limit=10`;
                if (fase && fase !== 'all') {
                    url += `&fase=${fase}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar conversaciones');
                
                const data = await response.json();
                
                if (data.success) {
                    renderConversations(data.conversations);
                    renderPagination(data.pagination);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('conversationsContent').innerHTML = 
                    '<div class="error">Error al cargar las conversaciones</div>';
            }
        }
        
        function renderConversations(conversations) {
            if (conversations.length === 0) {
                document.getElementById('conversationsContent').innerHTML = 
                    '<div class="loading">No hay conversaciones disponibles</div>';
                return;
            }
            
            let html = `
                <table class="conversations-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre</th>
                            <th>Fase</th>
                            <th>Mensajes</th>
                            <th>Estado</th>
                            <th>√öltima Actividad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            conversations.forEach(conv => {
                const isBlocked = conv.observaciones && conv.observaciones.toLowerCase().includes('stop');
                const statusClass = isBlocked ? 'blocked' : 'active';
                const statusText = isBlocked ? 'Bloqueado' : 'Activo';
                const phaseClass = conv.fase ? conv.fase.replace(/\s+/g, '-') : 'inicial';
                const lastActivity = new Date(conv.updated_at).toLocaleString('es-CO');
                
                html += `
                    <tr>
                        <td>${conv.user_id}</td>
                        <td>${conv.nombre || 'Sin nombre'}</td>
                        <td><span class="phase-badge phase-${phaseClass}">${conv.fase || 'inicial'}</span></td>
                        <td>${conv.message_count || conv.total_mensajes || 0}</td>
                        <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                        <td>${lastActivity}</td>
                        <td>
                            <button 
                                onclick="viewConversation('${conv.user_id}', '${conv.nombre || 'Usuario'}')" 
                                style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; margin-right: 5px;"
                                title="Ver conversaci√≥n completa">
                                üëÅÔ∏è Ver
                            </button>
                            <button 
                                onclick="clearConversationHistory('${conv.user_id}', '${conv.nombre || 'Usuario'}')" 
                                style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;"
                                title="Borrar historial de conversaci√≥n">
                                üóëÔ∏è Borrar
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('conversationsContent').innerHTML = html;
        }
        
        function renderPagination(pagination) {
            let html = '';
            
            html += `<button class="page-btn" onclick="changePage(${pagination.page - 1})" 
                     ${pagination.page === 1 ? 'disabled' : ''}>Anterior</button>`;
            
            for (let i = 1; i <= Math.min(pagination.totalPages, 5); i++) {
                html += `<button class="page-btn ${i === pagination.page ? 'active' : ''}" 
                         onclick="changePage(${i})">${i}</button>`;
            }
            
            html += `<button class="page-btn" onclick="changePage(${pagination.page + 1})" 
                     ${pagination.page === pagination.totalPages ? 'disabled' : ''}>Siguiente</button>`;
            
            document.getElementById('pagination').innerHTML = html;
        }
        
        function filterConversations(fase) {
            currentFilter = fase;
            currentPage = 1;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadConversations(currentPage, fase);
        }
        
        function changePage(page) {
            if (page < 1) return;
            currentPage = page;
            loadConversations(page, currentFilter);
        }
        
        function loadData() {
            loadDashboard();
            loadConversations(currentPage, currentFilter);
        }
        
        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
        
        // Initial load
        loadData();
        
        // Funci√≥n para carga masiva de StopBot con debug
        async function submitBulkStopBot() {
            console.log('=== INICIO BULK STOPBOT ===');
            
            const numbersText = document.getElementById('bulkNumbers').value.trim();
            const reason = document.getElementById('stopReason').value.trim() || 'Carga masiva';
            
            console.log('Texto de n√∫meros:', numbersText);
            console.log('Raz√≥n:', reason);
            
            if (!numbersText) {
                alert('Debe ingresar al menos un n√∫mero');
                return;
            }
            
            // Parsear n√∫meros (separados por l√≠neas, comas, espacios)
            const numbers = numbersText
                .split(/[\n,\s]+/)
                .map(n => n.trim())
                .filter(n => n.length > 0);
                
            console.log('N√∫meros parseados:', numbers);
            console.log('Cantidad de n√∫meros:', numbers.length);
            
            if (numbers.length === 0) {
                alert('No se encontraron n√∫meros v√°lidos');
                return;
            }
            
            if (!confirm(`¬øEst√° seguro de marcar ${numbers.length} n√∫meros como stopBot?`)) {
                console.log('Cancelado por usuario');
                return;
            }
            
            console.log('Confirmado, enviando petici√≥n...');
            console.log('Token:', API_TOKEN);
            
            // Dividir en lotes de 100 n√∫meros para evitar timeouts
            const BATCH_SIZE = 100;
            const batches = [];
            
            for (let i = 0; i < numbers.length; i += BATCH_SIZE) {
                batches.push(numbers.slice(i, i + BATCH_SIZE));
            }
            
            console.log(`Dividiendo en ${batches.length} lotes de m√°ximo ${BATCH_SIZE} n√∫meros`);
            
            let totalProcessed = 0;
            let totalCreated = 0;
            let totalUpdated = 0;
            let totalErrors = [];
            
            // Procesar lote por lote
            for (let i = 0; i < batches.length; i++) {
                const batch = batches[i];
                console.log(`Procesando lote ${i + 1}/${batches.length} con ${batch.length} n√∫meros...`);
                
                try {
                    const requestData = {
                        numbers: batch,
                        reason: `${reason} - Lote ${i + 1}/${batches.length}`
                    };
                    
                    const response = await fetch('/api/admin/bulk/stopbot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_TOKEN}`
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    console.log(`Lote ${i + 1} - Status:`, response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Error en lote ${i + 1}:`, response.status, errorText);
                        totalErrors.push(`Lote ${i + 1}: ${errorText}`);
                        continue;
                    }
                    
                    const data = await response.json();
                    console.log(`Lote ${i + 1} - Respuesta:`, data);
                    
                    if (data.success && data.results) {
                        totalProcessed += data.results.processed || 0;
                        totalCreated += data.results.created || 0;
                        totalUpdated += data.results.updated || 0;
                        if (data.results.errors) {
                            totalErrors.push(...data.results.errors);
                        }
                    }
                    
                    // Pausa de 500ms entre lotes para no sobrecargar el servidor
                    if (i < batches.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                } catch (error) {
                    console.error(`Error en lote ${i + 1}:`, error);
                    totalErrors.push(`Lote ${i + 1}: ${error.message}`);
                }
            }
            
            console.log('=== RESUMEN FINAL ===');
            console.log('Total procesados:', totalProcessed);
            console.log('Total creados:', totalCreated);
            console.log('Total actualizados:', totalUpdated);
            console.log('Total errores:', totalErrors.length);
            
            // Mostrar resultado final
            const successMessage = `Procesamiento completado:\n` +
                `- Procesados: ${totalProcessed}\n` +
                `- Creados: ${totalCreated}\n` +
                `- Actualizados: ${totalUpdated}\n` +
                `- Errores: ${totalErrors.length}`;
            
            alert(successMessage);
            
            if (totalErrors.length > 0) {
                console.log('Errores detallados:', totalErrors);
                alert(`Se encontraron ${totalErrors.length} errores. Ver consola para detalles.`);
            }
            
            // Limpiar campos si fue exitoso
            if (totalProcessed > 0) {
                document.getElementById('bulkNumbers').value = '';
                document.getElementById('stopReason').value = '';
                loadData(); // Recargar datos
            }
            
            return; // Salir de la funci√≥n aqu√≠
            
            try {
                // C√≥digo original comentado
                /*
                const requestData = {
                    numbers: numbers,
                    reason: reason
                };
                
                console.log('Datos a enviar:', requestData);
                
                const response = await fetch('/api/admin/bulk/stopbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_TOKEN}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Respuesta HTTP status:', response.status);
                console.log('Respuesta HTTP ok:', response.ok);
                */
                
            } catch (error) {
                console.error('Error general:', error);
                alert(`Error: ${error.message}`);
            }
            
            console.log('=== FIN BULK STOPBOT ===');
        }
        
        // Funci√≥n para corregir usuarios bloqueados
        async function fixBlockedUsers() {
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Corrigiendo...';
            
            try {
                const response = await fetch('/api/admin/fix-blocked-users', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                const resultDiv = document.getElementById('fixResult');
                
                if (data.success) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#155724';
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.padding = '10px';
                    resultDiv.style.borderRadius = '4px';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Correcci√≥n completada</strong><br>
                        - Usuarios corregidos: ${data.fixed}<br>
                        - Total bloqueados ahora: ${data.totalBlocked}
                    `;
                    
                    // Recargar el dashboard para actualizar las estad√≠sticas
                    setTimeout(() => {
                        loadDashboard();
                    }, 1000);
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#721c24';
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.padding = '10px';
                    resultDiv.style.borderRadius = '4px';
                    resultDiv.innerHTML = `‚ùå Error: ${data.error}`;
                }
            } catch (error) {
                console.error('Error ejecutando correcci√≥n:', error);
                alert('Error al ejecutar la correcci√≥n');
            } finally {
                button.disabled = false;
                button.textContent = 'üîß Corregir Usuarios Bloqueados';
            }
        }
        
        // Funci√≥n para ver conversaci√≥n completa
        async function viewConversation(userId, userName) {
            try {
                // Obtener la conversaci√≥n completa
                const response = await fetch(`/api/admin/conversations/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.conversation) {
                    displayConversationModal(data.conversation, userName);
                } else {
                    alert(`‚ùå Error: ${data.error || 'No se pudo cargar la conversaci√≥n'}`);
                }
            } catch (error) {
                console.error('Error cargando conversaci√≥n:', error);
                alert('‚ùå Error al cargar la conversaci√≥n');
            }
        }
        
        function displayConversationModal(conversation, userName) {
            const modal = new bootstrap.Modal(document.getElementById('conversationModal'));
            const modalTitle = document.getElementById('conversationModalLabel');
            const conversationContent = document.getElementById('conversationContent');
            
            // Configurar t√≠tulo del modal
            modalTitle.innerHTML = `
                Conversaci√≥n con <strong>${userName}</strong> (${conversation.userId})
                <br><small class="text-muted">
                    Fase: ${conversation.fase} | 
                    Total mensajes: ${conversation.totalMensajes} |
                    √öltima actualizaci√≥n: ${new Date(conversation.ultimaActualizacion).toLocaleString('es-CO')}
                </small>
            `;
            
            // Generar contenido de mensajes
            let html = '';
            
            if (!conversation.mensajes || conversation.mensajes.length === 0) {
                html = '<div class="text-muted text-center p-3">No hay mensajes en esta conversaci√≥n</div>';
            } else {
                conversation.mensajes.forEach((mensaje, index) => {
                    const timestamp = new Date(mensaje.timestamp).toLocaleString('es-CO');
                    let actorClass = '';
                    let actorIcon = '';
                    let actorName = '';
                    
                    switch (mensaje.from) {
                        case 'usuario':
                            actorClass = 'bg-light border-start border-primary border-3';
                            actorIcon = 'üë§';
                            actorName = 'Usuario';
                            break;
                        case 'sistema':
                            actorClass = 'bg-info bg-opacity-10 border-start border-info border-3';
                            actorIcon = 'ü§ñ';
                            actorName = 'Bot';
                            break;
                        case 'admin':
                            actorClass = 'bg-warning bg-opacity-10 border-start border-warning border-3';
                            actorIcon = 'üë®‚Äçüíº';
                            actorName = 'Administrador';
                            break;
                        default:
                            actorClass = 'bg-secondary bg-opacity-10 border-start border-secondary border-3';
                            actorIcon = '‚ùì';
                            actorName = mensaje.from || 'Desconocido';
                    }
                    
                    html += `
                        <div class="message-item mb-3 p-3 rounded ${actorClass}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="fw-bold">
                                    ${actorIcon} ${actorName}
                                </div>
                                <small class="text-muted">${timestamp}</small>
                            </div>
                            <div class="message-text">
                                ${mensaje.mensaje.replace(/\n/g, '<br>')}
                            </div>
                            ${mensaje.tipo ? `<small class="text-muted d-block mt-1">Tipo: ${mensaje.tipo}</small>` : ''}
                        </div>
                    `;
                });
            }
            
            // Agregar informaci√≥n adicional
            if (conversation.observaciones) {
                html += `
                    <div class="alert alert-warning mt-3">
                        <strong>üìù Observaciones:</strong> ${conversation.observaciones}
                    </div>
                `;
            }
            
            if (conversation.truncated) {
                html += `
                    <div class="alert alert-info mt-3">
                        <strong>‚ÑπÔ∏è Nota:</strong> Esta conversaci√≥n ha sido truncada. Solo se muestran los √∫ltimos mensajes.
                    </div>
                `;
            }
            
            conversationContent.innerHTML = html;
            modal.show();
        }
        
        // Funci√≥n para borrar historial de conversaci√≥n
        async function clearConversationHistory(userId, userName) {
            if (!confirm(`¬øEst√°s seguro de que quieres borrar todo el historial de conversaci√≥n de ${userName} (${userId})?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/conversations/${userId}/history`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Historial borrado exitosamente para ${userName}`);
                    // Recargar las conversaciones para actualizar la vista
                    loadConversations();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error borrando historial:', error);
                alert('‚ùå Error al borrar el historial');
            }
        }
        
        // Funciones para buscar y gestionar usuarios bloqueados
        async function searchBlockedUsers() {
            const searchTerm = document.getElementById('searchBlockedUser').value.trim();
            if (!searchTerm) {
                alert('Por favor ingresa un n√∫mero o nombre para buscar');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/blocked-users/search?q=${encodeURIComponent(searchTerm)}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    displayBlockedUsers(data.users);
                } else {
                    alert('Error al buscar usuarios: ' + data.error);
                }
            } catch (error) {
                console.error('Error buscando usuarios:', error);
                alert('Error al buscar usuarios');
            }
        }
        
        async function loadAllBlockedUsers() {
            try {
                const response = await fetch('/api/admin/blocked-users', {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    displayBlockedUsers(data.users);
                } else {
                    alert('Error al cargar usuarios bloqueados: ' + data.error);
                }
            } catch (error) {
                console.error('Error cargando usuarios bloqueados:', error);
                alert('Error al cargar usuarios bloqueados');
            }
        }
        
        function displayBlockedUsers(users) {
            const resultsDiv = document.getElementById('blockedUsersResults');
            
            if (!users || users.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #6c757d;">No se encontraron usuarios bloqueados</p>';
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #e9ecef;">
                            <th style="padding: 10px; text-align: left;">N√∫mero</th>
                            <th style="padding: 10px; text-align: left;">Nombre</th>
                            <th style="padding: 10px; text-align: left;">Fecha Bloqueo</th>
                            <th style="padding: 10px; text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            users.forEach(user => {
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px;">${user.user_id}</td>
                        <td style="padding: 10px;">${user.nombre || 'Sin nombre'}</td>
                        <td style="padding: 10px;">${new Date(user.updated_at).toLocaleString()}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button 
                                onclick="unblockUser('${user.user_id}')" 
                                style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ‚úÖ Desbloquear
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }
        
        async function unblockUser(userId) {
            if (!confirm(`¬øEst√°s seguro de que quieres desbloquear a ${userId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/unblock/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`Usuario ${userId} desbloqueado exitosamente`);
                    // Recargar la lista
                    searchBlockedUsers();
                    // Actualizar el dashboard
                    loadDashboard();
                } else {
                    alert('Error al desbloquear usuario: ' + data.error);
                }
            } catch (error) {
                console.error('Error desbloqueando usuario:', error);
                alert('Error al desbloquear usuario');
            }
        }
    </script>
    
    <!-- Modal para ver conversaci√≥n -->
    <div class="modal fade" id="conversationModal" tabindex="-1" aria-labelledby="conversationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conversationModalLabel">Conversaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="conversationContent" style="max-height: 500px; overflow-y: auto;">
                        <!-- Contenido de la conversaci√≥n aparecer√° aqu√≠ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>