const fetch = (...args) => import('node-fetch').then(({ default: fetch }) => fetch(...args));
const { sendMessage } = require('../utils/sendMessage');
const { guardarConversacionEnWix, obtenerConversacionDeWix } = require('../utils/wixAPI');

// Funci√≥n de utilidad para evitar mensajes duplicados
function limpiarDuplicados(historial) {
    const vistos = new Set();
    return historial.filter(m => {
        const clave = `${m.from}|${m.mensaje}`;
        if (vistos.has(clave)) return false;
        vistos.add(clave);
        return true;
    });
}

// Funci√≥n para enviar y guardar mensaje
async function enviarMensajeYGuardar({ to, userId, nombre, texto, remitente = "sistema" }) {
    try {
        if (to) {
            const resultado = await sendMessage(to, texto);
            if (!resultado.success && resultado.error) {
                console.error(`‚ùå Error enviando mensaje a ${to}:`, resultado.error);
            }
        }
        
        const { mensajes: historial = [] } = await obtenerConversacionDeWix(userId);
        const historialLimpio = limpiarDuplicados(historial);
        const nuevoHistorial = limpiarDuplicados([
            ...historialLimpio,
            { from: remitente, mensaje: texto }
        ]);
        
        await guardarConversacionEnWix({ userId, nombre, mensajes: nuevoHistorial });
        return { success: true };
    } catch (error) {
        console.error(`‚ùå Error en enviarMensajeYGuardar para ${userId}:`, error.message);
        return { success: false, error: error.message };
    }
}

// Funci√≥n para clasificar la imagen usando OpenAI
async function clasificarImagen(base64Image, mimeType) {
    const prompt = `Clasifica esta imagen en UNA de estas categor√≠as y responde SOLO la etiqueta:
‚Ä¢ comprobante_pago (transferencias bancarias, recibos de pago, capturas de Nequi, Daviplata, etc.)
‚Ä¢ listado_examenes (√≥rdenes m√©dicas, listas de ex√°menes solicitados)
‚Ä¢ confirmacion_cita (capturas de agendamiento, confirmaciones de citas m√©dicas)
‚Ä¢ documento_identidad (c√©dula, pasaporte, documentos de identificaci√≥n)
‚Ä¢ otro (cualquier otra imagen)

Responde √∫nicamente la etiqueta correspondiente.`;

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${process.env.OPENAI_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: prompt },
                        { type: 'image_url', image_url: { url: `data:${mimeType};base64,${base64Image}` } }
                    ]
                }],
                max_tokens: 10
            })
        });

        const result = await response.json();
        return result.choices?.[0]?.message?.content?.trim().toLowerCase() || "otro";
    } catch (error) {
        console.error("Error clasificando imagen:", error);
        return "otro";
    }
}

// Funci√≥n para extraer valor de comprobante de pago
async function extraerValorPago(base64Image, mimeType) {
    const prompt = "Extrae SOLO el valor pagado (valor de la transferencia en pesos colombianos) que aparece en este comprobante bancario. Ten en cuenta si tiene puntos o comas. Responde solo el valor exacto, sin explicaciones, ni s√≠mbolos adicionales.";

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${process.env.OPENAI_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: prompt },
                        { type: 'image_url', image_url: { url: `data:${mimeType};base64,${base64Image}` } }
                    ]
                }],
                max_tokens: 50
            })
        });

        const result = await response.json();
        return result.choices?.[0]?.message?.content?.trim() || "No detectado";
    } catch (error) {
        console.error("Error extrayendo valor:", error);
        return "Error al procesar";
    }
}

// Funci√≥n para extraer informaci√≥n de listado de ex√°menes
async function analizarListadoExamenes(base64Image, mimeType) {
    const prompt = `Analiza esta imagen de una orden m√©dica o listado de ex√°menes y extrae:
1. Tipo de ex√°menes solicitados
2. Si menciona "ocupacional" o "preocupacional"
3. Empresa o entidad que solicita
4. Cualquier informaci√≥n relevante

Responde de forma concisa y organizada.`;

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${process.env.OPENAI_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: prompt },
                        { type: 'image_url', image_url: { url: `data:${mimeType};base64,${base64Image}` } }
                    ]
                }],
                max_tokens: 200
            })
        });

        const result = await response.json();
        return result.choices?.[0]?.message?.content?.trim() || "No se pudo analizar el listado";
    } catch (error) {
        console.error("Error analizando listado:", error);
        return "Error al analizar el listado";
    }
}

async function procesarImagen(message, res) {
    const from = message.from;
    const nombre = message.from_name || "Nombre desconocido";
    const chatId = message.chat_id;
    const to = chatId || `${from}@s.whatsapp.net`;

    console.log(`üì∑ Procesando imagen de: ${from} (${nombre})`);

    // ‚úÖ Ignorar si la imagen fue enviada por el admin o el bot
    const BOT_NUMBER = "573008021701";
    if (message.from_me === true || message.from === BOT_NUMBER) {
        console.log("üì∑ Imagen ignorada: fue enviada por el admin o el bot.");
        return res.json({ success: true, mensaje: "Imagen del admin ignorada." });
    }

    // ‚úÖ Verificaci√≥n de observaciones para STOP
    const { observaciones = "" } = await obtenerConversacionDeWix(from);
    if (String(observaciones).toLowerCase().includes("stop")) {
        console.log(`üõë Usuario bloqueado por observaciones: ${from}`);
        return res.json({ success: true, mensaje: "Usuario bloqueado por observaciones (silencioso)." });
    }

    const imageId = message.image?.id;
    const mimeType = message.image?.mime_type || "image/jpeg";
    const urlImg = `https://gate.whapi.cloud/media/${imageId}`;

    // 1. Guardar que el usuario envi√≥ una imagen
    await enviarMensajeYGuardar({
        to: null, // No enviar mensaje al usuario a√∫n
        userId: from,
        nombre,
        texto: "üì∑ Imagen enviada",
        remitente: "usuario"
    });

    // 2. Enviar mensaje de procesamiento
    await enviarMensajeYGuardar({
        to,
        userId: from,
        nombre,
        texto: "üîç Un momento por favor...",
        remitente: "sistema"
    });

    // 3. Esperar para asegurar disponibilidad de la imagen
    await new Promise(resolve => setTimeout(resolve, 3000));

    try {
        // 4. Descargar la imagen
        const whapiRes = await fetch(urlImg, {
            method: 'GET',
            headers: { "Authorization": `Bearer ${process.env.WHAPI_KEY}` }
        });

        if (!whapiRes.ok) {
            const errorText = await whapiRes.text();
            console.error("‚ùå Error descargando imagen de Whapi:", errorText);
            
            await enviarMensajeYGuardar({
                to,
                userId: from,
                nombre,
                texto: "Lo siento, no pude procesar tu imagen. Por favor intenta de nuevo.",
                remitente: "sistema"
            });
            
            return res.status(500).json({ success: false, error: "No se pudo descargar la imagen" });
        }

        const arrayBuffer = await whapiRes.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        const base64Image = buffer.toString('base64');

        // 5. Clasificar la imagen
        const tipoImagen = await clasificarImagen(base64Image, mimeType);
        console.log(`üéØ Tipo de imagen detectado: ${tipoImagen}`);

        let mensajeContexto = "";
        let mensajeRespuesta = "";

        // 6. Procesar seg√∫n el tipo de imagen
        switch (tipoImagen) {
            case "comprobante_pago":
                console.log("üí∞ Procesando comprobante de pago");
                
                const valorPago = await extraerValorPago(base64Image, mimeType);
                const valorNumerico = valorPago.replace(/[^0-9]/g, "");
                const valorEsValido = /^[0-9]{4,}$/.test(valorNumerico);

                mensajeContexto = valorEsValido 
                    ? `üì∑ Comprobante de pago recibido - Valor detectado: $${valorNumerico}`
                    : "üì∑ Comprobante de pago recibido - Valor no detectado";

                if (valorEsValido) {
                    mensajeRespuesta = "Ahora escribe SOLO tu n√∫mero de documento *(sin puntos ni letras)*.";
                } else {
                    mensajeRespuesta = "No pude identificar el valor en el comprobante. Por favor env√≠a una imagen m√°s clara del soporte de pago.";
                }
                break;

            case "listado_examenes":
                console.log("üìã Procesando listado de ex√°menes");
                
                const analisisExamenes = await analizarListadoExamenes(base64Image, mimeType);
                mensajeContexto = "üìã Listado de ex√°menes recibido";
                mensajeRespuesta = `He revisado tu orden m√©dica.\n\nü©∫ Nuestras opciones para ex√°menes ocupacionales:\n‚Ä¢ Virtual: $46.000\n‚Ä¢ Presencial: $69.000\n\n¬øCu√°l opci√≥n prefieres?`;
                break;

            case "confirmacion_cita":
                console.log("üìÖ Procesando confirmaci√≥n de cita");
                
                mensajeContexto = "üìÖ Confirmaci√≥n de cita recibida";
                mensajeRespuesta = "He recibido tu confirmaci√≥n de cita. Para consultar informaci√≥n espec√≠fica, proporciona tu n√∫mero de documento.";
                break;

            case "documento_identidad":
                console.log("üÜî Procesando documento de identidad");
                
                mensajeContexto = "üÜî Documento de identidad recibido";
                mensajeRespuesta = "He recibido tu documento. ¬øNecesitas consultar informaci√≥n sobre tu cita o realizar un examen m√©dico?";
                break;

            default: // "otro"
                console.log("‚ùì Imagen no identificada");
                
                mensajeContexto = "üì∑ Imagen recibida - Tipo no identificado";
                mensajeRespuesta = "He recibido tu imagen, pero no pude identificar qu√© tipo de documento es. ¬øPodr√≠as explicarme qu√© necesitas?";
                break;
        }

        // 7. Guardar el contexto de la imagen procesada
        await enviarMensajeYGuardar({
            to: null, // Solo guardar, no enviar
            userId: from,
            nombre,
            texto: mensajeContexto,
            remitente: "sistema"
        });

        // 8. Enviar respuesta final al usuario
        await enviarMensajeYGuardar({
            to,
            userId: from,
            nombre,
            texto: mensajeRespuesta,
            remitente: "sistema"
        });

        console.log(`‚úÖ Imagen procesada exitosamente para ${from}: ${tipoImagen}`);

        return res.json({
            success: true,
            mensaje: "Imagen procesada correctamente.",
            tipoImagen,
            contexto: mensajeContexto,
            respuesta: mensajeRespuesta
        });

    } catch (error) {
        console.error("‚ùå Error procesando imagen:", error);
        
        await enviarMensajeYGuardar({
            to,
            userId: from,
            nombre,
            texto: "Ocurri√≥ un error procesando tu imagen. Por favor intenta de nuevo o contacta con un asesor.",
            remitente: "sistema"
        });

        return res.status(500).json({ 
            success: false, 
            error: "Error interno procesando imagen",
            details: error.message 
        });
    }
}

module.exports = { procesarImagen };